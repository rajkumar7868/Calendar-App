<div class="calendar">
  <div class="controls">
    <button (click)="goToToday()">Today</button>
    <button (click)="changeDate(-1)">‹</button>
    <div class="title">{{ currentDate | date:(mode === 'month' ? 'MMMM yyyy' : 'mediumDate') }}</div>
    <button (click)="changeDate(1)">›</button>
    <div class="view-selectors">
      <button [class.active]="mode==='month'" (click)="changeMode('month')">Month</button>
      <button [class.active]="mode==='week'" (click)="changeMode('week')">Week</button>
      <button [class.active]="mode==='day'" (click)="changeMode('day')">Day</button>
    </div>
  </div>

  <!-- MONTH VIEW -->
  <div *ngIf="mode === 'month'">
    <div class="weekdays" *ngIf="!isMobile">
      <div *ngFor="let wd of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']">{{ wd }}</div>
    </div>
    <div class="grid" [class.mobile]="isMobile">
      <div class="cell" *ngFor="let day of days" [class.other-month]="day.date.getMonth() !== currentDate.getMonth()"
        (click)="openEventForm(day.date)" cdkDropList (cdkDropListDropped)="onEventDropped($event, day.date)">
        <div class="date">{{ day.date.getDate() }}</div>
        <div class="evs">
          <div class="ev tooltip-wrapper" *ngFor="let e of day.events" cdkDrag (cdkDragStarted)="onDragStarted(e)"
            (cdkDragEnded)="onDragEnded()" [style.background]="e.color" (mouseenter)="showTooltip($event, e)"
            (mouseleave)="hideTooltip()" (click)="editEvent(e); $event.stopPropagation()">
            {{ e.title }} {{ e.category }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- WEEK / DAY VIEW -->
  <div *ngIf="mode === 'week' || mode === 'day'" class="timeslot-grid">
    <div class="day-headers">
      <div class="time-column-header"></div>
      <div class="day-header" *ngFor="let day of days" (click)="changeMode('day'); currentDate = day.date; buildView()">
        {{ day.date | date:'EEE d/M' }}
      </div>
    </div>
    <div class="grid-container">
      <div class="time-column">
        <div class="hour-row" *ngFor="let h of hours; index as i">
          <div *ngIf="i < 24">
            {{ h === 0 ? '12 AM' : (h === 12 ? '12 PM' : (h < 12 ? h + ' AM' : h - 12 + ' PM' )) }} </div>
          </div>
        </div>
        <div class="day-columns-container" [class.week-view]="mode === 'week'">
          <div class="day-column" *ngFor="let day of days" cdkDropList
            (cdkDropListDropped)="onEventDropped($event, day.date)">
            <div class="hour-slot" *ngFor="let h of hours; index as i" (click)="openEventForm(day.date)"
              [attr.data-hour]="h" cdkDropList (cdkDropListDropped)="onEventDropped($event, day.date, h)">
              <ng-container *ngFor="let e of getEventsForHour(day, h)">
                <div class="timeslot-ev tooltip-wrapper" *ngFor="let e of getEventsForHour(day, h)" cdkDrag
                  (cdkDragStarted)="onDragStarted(e)" (cdkDragEnded)="onDragEnded()"
                  (mouseenter)="showTooltip($event, e)" (mouseleave)="hideTooltip()" [style.background]="e.color"
                  [style.height.px]="getEventHeightAndTop(e).height" [style.top.px]="getEventHeightAndTop(e).top"
                  (click)="editEvent(e); $event.stopPropagation()">
                  {{ e.title }} {{ e.category }}
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>

    <app-event-form></app-event-form>
    <app-conflict-modal></app-conflict-modal>

    <div *ngIf="hoveredEvent" class="global-tooltip" [style.top.px]="tooltipPosition.top"
      [style.left.px]="tooltipPosition.left">
      <div class="tooltip-arrow"></div>
      <div class="tooltip-content">
        <div><strong>Title:</strong> {{ hoveredEvent.title }} {{ hoveredEvent.category }}</div>
        <div><strong>Time:</strong> {{ hoveredEvent.start | date:'shortTime' }} - {{ hoveredEvent.end | date:'shortTime'
          }}</div>
        <div><strong>Participants:</strong> {{ (hoveredEvent.participants || []).join(', ') || 'N/A' }}</div>
        <div><strong>Notes:</strong> {{ hoveredEvent.notes || 'No notes' }}</div>
      </div>
    </div>
  </div>